1. # 概述

主符号表首先需要保存全局常量、变量，子函数/过程。其次，为了保证库程序名、主程序名、主程序参数名不被重定义，主符号表中还需保存库程序项、主程序名项、主程序参数项。

符号表分为主符号表和子符号表。

主符号表首先需要保存全局常量、变量，子函数/过程。其次，为了保证库程序名、主程序名、主程序参数名不被重定义，主符号表中还需保存库程序项、主程序名项、主程序参数项。

子符号表中，除了需要保存局部常量、变量等，还需保存子程序参数（传值参数、引用参数），当然为了避免子程序中的标识符与当前子程序名同名，还需将子程序名保存到子符号表中；由于我们不支持函数/过程的嵌套定义，所以子符号表不包含子程序这一项。

符号表的第 0 个位置，存放的必然是该符号表对应的程序名，第 1 到第 amount 个位置，存放的必然是该符号表对应的程序所定义的 amount 个参数；另外主符号表还将 read、write、writeln、exit 存放在了第 amount+1 到第 amount+4 个的位置。主符号表和子符号表接下来的位置都先存放了所有的常量定义，再存放了所有的变量定义。最后主符号表还保存了所有的子程序定义，按照文法规定，子过程和子函数的存放位置没有必然的先后关系，可以混合存储。

# 表项分析

一个表项record记录了一个标识符的相关信息。

主符号表和子符号表的逻辑结构差别不大，所以表类和表项类均统一设计。各种不同的标识符分析如下表所示：

# 接口描述

## 传值参数的添加

- 函数定义

```C++
void addPara(string id, int lineNumber, string type)
```

- 参数列表

| 参数       | 说明             |
| ---------- | ---------------- |
| string id  | 传值参数的 id    |
| lineNumber | 传值参数所在行号 |
| type       | 传值参数的类型   |

- 函数功能

将传值参数类型的标识符添加到符号表中

## 引用参数的添加

- 函数定义

```C++
void addVarPara(string id, int lineNumber, string type)
```

- 参数列表

| 参数       | 说明               |
| ---------- | ------------------ |
| string id  | 传引用参数的 id    |
| lineNumber | 传引用参数所在行号 |
| type       | 传引用参数的类型   |

- 函数功能

将传引用参数类型的标识符加到符号表中

## 普通变量的添加

- 函数定义

```C++
void addVar (string id, int lineNumber, string type)
```

- 参数列表

| 参数       | 说明         |
| :--------- | :----------- |
| string id  | 变量的 id    |
| lineNumber | 变量所在行号 |
| type       | 变量的类型   |

- 函数功能

将变量类型的标识符加到符号表中

## 常量的添加

- 函数定义

```C++
void addConst(string id, int lineNumber, string type, bool isMinusShow, string value)
```

- 参数列表

| 参数        | 说明                     |
| :---------- | :----------------------- |
| string id   | 常量的 id                |
| lineNumber  | 常量所在行号             |
| type        | 常量的类型               |
| isMinusShow | 判断常量标识符符号的正负 |
| value       | 常量标识符的值           |

- 函数功能

将常量类型的标识符加到符号表中

## 数组的添加

- 函数定义

```C++
void addArray (string id, int lineNumber, string type, int amount, vector< pair<int, int> > arrayRangeList)
```

- 参数列表

| 参数                                    | 说明               |
| :-------------------------------------- | :----------------- |
| string id                               | 数组的 id          |
| lineNumber                              | 数组所在行号       |
| type                                    | 数组的类型         |
| amount                                  | 数组的维数         |
| vector< pair<int, int> > arrayRangeList | 存储数组各维上下界 |

- 函数功能

将数组类型的标识符加到符号表中

## 过程方法的添加

- 函数定义

```C++
void addProcedure(string id, int lineNumber, int amount, _SymbolTable *subSymbolTable)
```

- 参数列表

| 参数                              | 说明                    |
| :-------------------------------- | :---------------------- |
| string id                         | procedure的 id          |
| lineNumber                        | procedure所在行号       |
| amount                            | procedure的维数         |
| _SymbolTable *subSymbolTable=NULL | procedure子符号表的指针 |

- 函数功能

将 Procedure 类型的标识符加到符号表中

## 函数的添加

- 函数定义

```C++
void addFunction(string id, int lineNumber, string type, int amount, _SymbolTable *subSymbolTable)
```

- 参数列表

| 参数                              | 说明                   |
| :-------------------------------- | :--------------------- |
| string id                         | 函数的 id              |
| lineNumber                        | 函数所在行号           |
| type                              | 函数返回值的类型       |
| amount                            | 函数参数的个数         |
| _SymbolTable *subSymbolTable=NULL | function子符号表的指针 |

- 函数功能

将 Function 类型的标识符加到符号表中

## 子程序符号表指针的添加

- 函数定义

```C++
addSubSymbolTable(string id, _SymbolTable *subSymbolTable)
```

- 参数列表

| 参数                              | 说明                    |
| :-------------------------------- | :---------------------- |
| string id                         | procedure的 id          |
| amount                            | procedure的维数         |
| _SymbolTable *subSymbolTable=NULL | procedure子符号表的指针 |

- 函数功能

将指向子符号表的指针加到主符号表中

## 主/子程序名的添加

- 函数定义

```C++
addProgramName(string id, int lineNumber, string subprogramType, int amount, string returnType)
```

- 参数列表

| 参数           | 说明                                                        |
| :------------- | :---------------------------------------------------------- |
| string id      | 主/子程序名的 id                                            |
| lineNumber     | 程序名所在行号                                              |
| subprogramType | 该program的类型，只有Function和Procedure两种                |
| amount         | program 的参数个数                                          |
| returnType     | 该 program 的返回值类型，若为Procedure，其返回值类型为 void |

- 函数功能

将当前 program 的程序名添加到其符号表第 0 个位置上

## 主程序参数的添加

- 函数定义

```C++
addVoidPara(string id, int lineNumber)
```

- 参数列表

| 参数       | 说明               |
| :--------- | :----------------- |
| string id  | 主程序参数的 id    |
| lineNumber | 主程序参数所在行号 |

- 函数功能

将主程序参数加入到符号表中

# 表项类定义及接口描述

## 表项定义

```C++
class record{
    string flag;
    string id;
    int lineNumber;
    string type;
    string value;
    bool isMinusShow;
    int amount;
    vector< pair<int,int> > arrayRangeList;
    _SymbolTable* subSymbolTable;
    string subprogramType;
};
```

| flag                   | 说明                           |
| :--------------------- | :----------------------------- |
| "value parameter"      | 表示传值参数                   |
| "var parameter"        | 表示传引用参数                 |
| "normal variant"       | 表示普通变量                   |
| "constant"             | 表示常量                       |
| "array"                | 表示数组                       |
| "procedure"            | 表示过程                       |
| "function"             | 表示函数                       |
| "(sub)program name"    | 表示当前符号表对应的程序名信息 |
| "parameter of program" | 表示主程序的参数               |

| 字段           | 说明                                                   |
| :------------- | :----------------------------------------------------- |
| id             | 当前标识符的ID                                         |
| lineNumber     | 定义标识符的行号                                       |
| type           | 标识符的类型：如"integer"、"real"、"char"、"boolean"等 |
| value          | 常量的值（非负数的无符号整数）                         |
| isMinusShow    | 常量是否为负数                                         |
| amount         | 数组的维数或函数/过程的参数个数                        |
| arrayRangeList | 数组各维的上下界                                       |
| subSymbolTable | 指向过程/函数对应的子符号表的指针                      |
| subprogramType | 表示程序名称及类型（函数或过程）的特殊记录             |

## 接口描述

### 设置为传值参数

- 定义

```C++
void setPara(string id, int lineNumber, string type)
```

- 参数列表

| 参数           | 说明             |
| :------------- | :--------------- |
| string id      | 传值参数的 id    |
| int lineNumber | 传值参数所在行号 |
| string type    | 传值参数的类型   |

- 功能

设置传值参数的具体信息，包括标识符、行号和类型等

### 设置为引用参数

- 定义

```C++
void setVarPara(string id, int lineNumber, string type)
```

- 参数列表

| 参数           | 说明               |
| :------------- | :----------------- |
| string id      | 传引用参数的 id    |
| int lineNumber | 传引用参数所在行号 |
| string type    | 传引用参数的类型   |

- 功能

设置传引用参数类型标识符所在记录的具体信息

### 设置为普通变量

- 定义

```C++
void setVar (string id, int lineNumber, string type)
```

- 参数列表

| 参数           | 说明         |
| :------------- | :----------- |
| string id      | 变量的 id    |
| int lineNumber | 变量所在行号 |
| string type    | 变量的类型   |

- 功能

设置变量类型标识符所在记录的具体信息

### 设置为常量

- 定义

```C++
void setConst(string id, int lineNumber, string type, bool isMinusShow, string value)
```

- 参数列表

| 参数             | 说明                                     |
| :--------------- | :--------------------------------------- |
| string id        | 常量的 id                                |
| int lineNumber   | 变量所在行号                             |
| string type      | 常量的类型                               |
| bool isMinusShow | 用于判断常量标识符符号正负的 bool 类型量 |
| string value     | 常量标识符的值                           |

- 功能

设置常量类型标识符所在记录的具体信息

### 设置为数组

- 定义

```C++
void setArray (string id, int lineNumber, string type, int amount, vector< pair<int, int> > arrayRangeList)
```

- 参数列表

| 参数                                    | 说明                        |
| :-------------------------------------- | :-------------------------- |
| string id                               | 数组的 id                   |
| int lineNumber                          | 数组所在行号                |
| string type                             | 数组的类型                  |
| int amount                              | 数组的维数                  |
| vector< pair<int, int> > arrayRangeList | 存储数组各维上下界的 vector |

- 功能

设置数组类型标识符所在记录的具体信息

### 设置为过程

- 定义

```C++
void setProcedure(string id, int lineNumber, int amount, _SymbolTable *subSymbolTable=NULL)
```

- 参数列表

| 参数                              | 说明                    |
| :-------------------------------- | :---------------------- |
| string id                         | procedure的 id          |
| int lineNumber                    | procedure所在行号       |
| int amount                        | procedure参数的个数     |
| _SymbolTable *subSymbolTable=NULL | procedure子符号表的指针 |

- 功能

设置 Procedure 类型标识符所在记录的具体信息

### 设置为函数

- 定义

```C++
void setFunction(string id, int lineNumber, string type, int amount, _SymbolTable *subSymbolTable=NULL)
```

- 参数列表

| 参数                              | 说明                   |
| :-------------------------------- | :--------------------- |
| string id                         | function的 id          |
| int lineNumber                    | function所在行号       |
| String type                       | function返回值的类型   |
| int amount                        | function参数的个数     |
| _SymbolTable *subSymbolTable=NULL | function子符号表的指针 |

- 功能

设置 Function 类型标识符所在记录的具体信息

### 设置为主/子函数

- 定义

```C++
setProgramName(string id, int lineNumber, string subprogramType, int amount, string returnType)
```

- 参数列表

| 参数                  | 说明                                                      |
| :-------------------- | :-------------------------------------------------------- |
| string id             | program 的 id                                             |
| int lineNumber        | program 所在行号                                          |
| String subprogramType | program 的类型，只有 Function 和Procedure 两种            |
| int amount            | program 的参数个数                                        |
| string returnType     | program 的返回值类型，若为 Procedure，其返回值类型为 void |

- 功能

设置当前 program 的程序名所在记录的具体信息

### 设置为主程序参数

- 定义

```C++
setVoidPara(string id, int lineNumber)
```

- 参数列表

| 参数           | 说明               |
| :------------- | :----------------- |
| string id      | 主程序参数的 id    |
| int lineNumber | 主程序参数所在行号 |

- 功能

设置主程序参数所在记录的具体信息

# 对外接口

## 查找当前所在符号表

- 定义

```C++
_SymbolRecord* findSymbolRecord(_SymbolTable* currentSymbolTable, string id, int mode)
```

- 参数列表

| 参数                             | 说明                         |
| :------------------------------- | :--------------------------- |
| _SymbolTable* currentSymbolTable | 指向当前符号表的指针         |
| string id                        | 标识符 id                    |
| int mode                         | 判断当前符号表是否为主符号表 |

- 功能

找出标识符在符号表中的位置

## 检查是否有同名

- 定义

```C++
bool checkIsTheSameAsKey(string id, int lineNumber)
```

- 参数列表

| 参数           | 说明       |
| :------------- | :--------- |
| string id      | 标识符 id  |
| int lineNumber | 标识符行号 |

- 功能

检查标识符是否与库程序名、主程序名、主程序参数同名

## 查找第n个形式参数的类型

- 定义

```C++
string findNthFormalParaType(int n)
```

- 参数列表

| 参数  | 说明            |
| :---- | :-------------- |
| int n | 第 n 维形式参数 |

- 功能

找到第 n 维形式参数的类型

## 检查第n个参数是否为引用调用

- 定义

```C++
bool isNthFormalParaRefered(int n)
```

- 参数列表

| 参数  | 说明            |
| :---- | :-------------- |
| int n | 第 n 维形式参数 |

- 功能

检查第 n 维形式参数是否是引用调用

## 检查第n维下标是否越界

- 定义

```C++
bool checkArrayNthIndexRange(int n,int index)
```

- 参数列表

| 参数      | 说明                  |
| :-------- | :-------------------- |
| int n     | 第 n 维形式参数       |
| int index | 第 n 个形式参数的下标 |

- 功能

检查第 n 维下标是否越界，true 表示越界，false 表示未越界

## 检查id是否为引用参数

- 定义

```C++
bool checkIsReferedPara(_SymbolTable* currentSymbolTable, string id)
```

- 参数列表

| 参数                             | 说明                 |
| :------------------------------- | :------------------- |
| _SymbolTable* currentSymbolTable | 指向当前符号表的指针 |
| string id                        | 标识符 id            |

- 功能

检查检查 id 是否是引用参数

## 符号表指针

- 指向主符号表的指针

```C++
_SymbolTable *mainSymbolTable;
```

- 指向当前符号表的指针

```C++
extern _SymbolTable *currentSymbolTable;
```